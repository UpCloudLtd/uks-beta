# Welcome to UKS Closed Beta!

This repository contains sample configurations for Terraform and Kubernetes manifests to get started with our UpCloud Kubernetes Service (UKS).

Note that this repository is still evolving. Please check back during the test period and also familiarise yourself with [the known issues](KNOWN_ISSUES.md)!

## Creating your first cluster

### UI
The simplest way to create a cluster is to use our Control Panel. You can do so by following these steps:

* Log in to the [UpCloud Control Panel](https://hub.upcloud.com) (you must use an account that participates in the Closed Beta)
* Go to `Kubernetes` section using the left-hand side menu
* Click `Create new cluster`
* The Closed Beta test is being run in a single zone, and the option has been pre-chosen for you
* Select a Private Network for your Worker Nodes. This network will need to be created in the same zone as the Alpha tests: de-fra1
* Create a node group; node group is a group of workers with identical image templates.
* Name your cluster
* Click `Create` button
* Cluster creation will take a few minutes as worker nodes are being provisioned and a DNS record is prepared
* When the cluster is Running, you can download your cluster's `KubeConfig` file; it allows you to access your cluster easily via command line

### Alternatives
You can also create a cluser using the following ways:
* Terraform - see [terraform/README.md](terraform/README.md) for more precise instructions
* Direct API access - see [openapi/openapi.yaml](openapi/openapi.yaml) for UKS Closed Beta API documentation; authentication can be achieved with [these](https://developers.upcloud.com/1.3/2-architecture/#authentication) instructions



### Troubleshooting

* Check [KNOWN_ISSUES.md](KNOWN_ISSUES.md)
* If you are attempting to access your cluster with a brand new `KubeConfig` and receive an error `no route to host`, this means that the DNS has not been fully configured, and you will need to wait a few more minutes.
  * Alternatively, you can flush your local DNS cache with: `sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder`
* If you use Terraform and you forgot to add `ignore_changes=[router]` meta argument, Terraform will detach router from your network making nodes in the cluster unavailable. To fix it you can go to [Control Panel routers page](https://hub.upcloud.com/networks/routers) and manually attach your network (the one you created with TF) to the router (it should be named as `<cluster-name>-data-plane`).

### Kubeconfig

You can get your kubeconfig by going to your cluster details page in [Control Panel](https://hub.upcloud.com/kubernetes).
Alternatively, if you use Terraform you can leverage `local_file` provider to create kubeconfig file after the cluster is deleted ([see terraform example](terraform/main.tf))

## Exposing Services

Create a deployment and expose it to the public Internet over HTTP by running the following commands:

```
kubectl create deployment --image=ghcr.io/upcloudltd/hello hello-uks
kubectl expose deployment hello-uks --port=80 --target-port=80 --type=LoadBalancer
kubectl get svc -w
```

This process will take a few minutes as our system will create a new load balancer to handle the traffic.

You can verify that it works by running this simple command:

```
$ curl http://lb-231912371233.upcloudlb.com
```

If you want to expose the service over HTTPS instead run the following:

```
kubectl expose deployment hello-uks --port=443 --target-port=80 --type=LoadBalancer --name=hello-uks-https
```

We provision a TLS certificate automatically for the autogenerated Load Balancer hostname.

## Persistent storage

See [storage/README.md](storage/README.md).  


